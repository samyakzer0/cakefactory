import React from 'react';
import { MeshStandardMaterial } from 'three';
import { useNavigate } from 'react-router-dom';

// --- Shared Materials ---
const materials = {
    wall: new MeshStandardMaterial({ color: '#fdf4dc' }), // Cream
    roof: new MeshStandardMaterial({ color: '#5d4037' }), // Chocolate
    glass: new MeshStandardMaterial({ color: '#81d4fa', transparent: true, opacity: 0.5, roughness: 0.0, metalness: 0.9 }), // Reflective glass
    frame: new MeshStandardMaterial({ color: '#d7ccc8' }), // Light wood/metal
    wrapper: new MeshStandardMaterial({ color: '#f48fb1' }),
    cakeBase: new MeshStandardMaterial({ color: '#f8bbd0' }), // Light Pink Cake
    frosting: new MeshStandardMaterial({ color: '#ffffff', roughness: 0.4 }),
    awningRed: new MeshStandardMaterial({ color: '#e53935' }),
    awningWhite: new MeshStandardMaterial({ color: '#ffffff' }),
    sign: new MeshStandardMaterial({ color: '#3e2723' }),
    metal: new MeshStandardMaterial({ color: '#455a64', metalness: 0.6, roughness: 0.4 }),
    leaf: new MeshStandardMaterial({ color: '#66bb6a' }),
    pot: new MeshStandardMaterial({ color: '#e64a19' }),
    pavement: new MeshStandardMaterial({ color: '#90a4ae' }),
    darkDoor: new MeshStandardMaterial({ color: '#3e2723' }), // Darker for frame
    interior: new MeshStandardMaterial({ color: '#1a100e' }), // Almost black for fake interior
    plate: new MeshStandardMaterial({ color: '#ffffff', metalness: 0.1, roughness: 0.2 }),
};

// --- Sub-Components ---

const Awning = ({ position, rotation = [0, 0, 0], width = 1.5 }) => {
    const segments = 5;
    const segmentWidth = width / segments;

    return (
        <group position={position} rotation={rotation}>
            {Array.from({ length: segments }).map((_, i) => (
                <mesh
                    key={i}
                    position={[(i - segments / 2) * segmentWidth + segmentWidth / 2, 0.4, 0.4]}
                    rotation={[Math.PI / 4, 0, 0]}
                    castShadow
                >
                    <capsuleGeometry args={[segmentWidth / 2.2, 1, 4, 8]} />
                    <primitive object={i % 2 === 0 ? materials.awningRed : materials.awningWhite} attach="material" />
                </mesh>
            ))}
        </group>
    );
};

const StreetLamp = ({ position }) => {
    return (
        <group position={position}>
            {/* Base */}
            <mesh position={[0, 0.1, 0]} castShadow receiveShadow material={materials.metal}>
                <cylinderGeometry args={[0.2, 0.3, 0.2, 8]} />
            </mesh>
            {/* Pole */}
            <mesh position={[0, 1.5, 0]} castShadow material={materials.metal}>
                <cylinderGeometry args={[0.08, 0.1, 3, 8]} />
            </mesh>
            {/* Lamp Head */}
            <group position={[0, 3, 0]}>
                <mesh position={[0, 0.2, 0]} material={materials.metal}>
                    <cylinderGeometry args={[0.3, 0.08, 0.4, 6]} />
                </mesh>
                <mesh position={[0, 0.2, 0]} material={materials.glass}>
                    <dodecahedronGeometry args={[0.25, 0]} />
                </mesh>
            </group>
        </group>
    );
};

const PlantPot = ({ position }) => {
    return (
        <group position={position}>
            <mesh position={[0, 0.2, 0]} castShadow material={materials.pot}>
                <cylinderGeometry args={[0.25, 0.15, 0.4, 8]} />
            </mesh>
            <mesh position={[0, 0.5, 0]} castShadow material={materials.leaf}>
                <dodecahedronGeometry args={[0.25, 0]} />
            </mesh>
            <mesh position={[0.15, 0.6, 0.1]} castShadow material={materials.leaf}>
                <dodecahedronGeometry args={[0.15, 0]} />
            </mesh>
            <mesh position={[-0.15, 0.6, -0.1]} castShadow material={materials.leaf}>
                <dodecahedronGeometry args={[0.18, 0]} />
            </mesh>
        </group>
    );
};

const ChairAndTable = ({ position, rotation = [0, 0, 0] }) => {
    return (
        <group position={position} rotation={rotation}>
            {/* Table */}
            <mesh position={[0, 0.4, 0]} castShadow material={materials.frame}>
                <cylinderGeometry args={[0.4, 0.4, 0.05, 16]} />
            </mesh>
            <mesh position={[0, 0.2, 0]} castShadow material={materials.metal}>
                <cylinderGeometry args={[0.05, 0.05, 0.4, 8]} />
            </mesh>
            <mesh position={[0, 0, 0]} castShadow material={materials.metal}>
                <cylinderGeometry args={[0.2, 0.2, 0.02, 8]} />
            </mesh>

            {/* Chair 1 */}
            <group position={[0.6, 0, 0]} rotation={[0, -1.5, 0]}>
                <mesh position={[0, 0.25, 0]} castShadow material={materials.frame}>
                    <boxGeometry args={[0.3, 0.05, 0.3]} />
                </mesh>
                <mesh position={[0, 0.125, 0.12]} castShadow material={materials.frame}>
                    <cylinderGeometry args={[0.03, 0.03, 0.25]} />
                </mesh>
                <mesh position={[0, 0.125, -0.12]} castShadow material={materials.frame}>
                    <cylinderGeometry args={[0.03, 0.03, 0.25]} />
                </mesh>
                <mesh position={[-0.12, 0.5, 0]} castShadow material={materials.frame}>
                    <boxGeometry args={[0.05, 0.5, 0.3]} />
                </mesh>
            </group>
            {/* Chair 2 */}
            <group position={[-0.6, 0, 0]} rotation={[0, 1.5, 0]}>
                <mesh position={[0, 0.25, 0]} castShadow material={materials.frame}>
                    <boxGeometry args={[0.3, 0.05, 0.3]} />
                </mesh>
                <mesh position={[0, 0.125, 0.12]} castShadow material={materials.frame}>
                    <cylinderGeometry args={[0.03, 0.03, 0.25]} />
                </mesh>
                <mesh position={[0, 0.125, -0.12]} castShadow material={materials.frame}>
                    <cylinderGeometry args={[0.03, 0.03, 0.25]} />
                    <mesh castShadow receiveShadow material={materials.roof}>
                        {/* Straight Cylinder: Top and Bottom radius 3.8, no slope */}
                        <cylinderGeometry args={[shopRadius + 0.3, shopRadius + 0.3, 0.6, 32]} />
                    </mesh>
            </group>

            {/* --- The Giant Cake Topper --- */}
            <group position={[0, shopHeight + 0.6, 0]}>
                {/* White Plate */}
                <mesh position={[0, 0.1, 0]} receiveShadow material={materials.plate}>
                    <cylinderGeometry args={[2.6, 2.6, 0.1, 32]} />
                </mesh>

                {/* Bottom Tier */}
                <mesh position={[0, 0.6, 0]} castShadow material={materials.cakeBase}>
                    <cylinderGeometry args={[2.2, 2.2, 1, 32]} />
                </mesh>
                {/* Piping/Frosting Bottom Tier */}
                {Array.from({ length: 24 }).map((_, i) => (
                    <mesh
                        key={`b-${i}`}
                        position={[2.1 * Math.sin((i / 24) * Math.PI * 2), 1.15, 2.1 * Math.cos((i / 24) * Math.PI * 2)]}
                        material={materials.frosting}
                    >
                        <sphereGeometry args={[0.15, 16, 16]} />
                    </mesh>
                ))}

                {/* Top Tier */}
                <mesh position={[0, 1.5, 0]} castShadow material={materials.cakeBase}>
                    <cylinderGeometry args={[1.5, 1.5, 0.8, 32]} />
                </mesh>
                {/* Piping/Frosting Top Tier */}
                {Array.from({ length: 16 }).map((_, i) => (
                    <mesh
                        key={`t-${i}`}
                        position={[1.4 * Math.sin((i / 16) * Math.PI * 2), 1.95, 1.4 * Math.cos((i / 16) * Math.PI * 2)]}
                        material={materials.frosting}
                    >
                        <sphereGeometry args={[0.12, 16, 16]} />
                    </mesh>
                ))}

                {/* Cherry Cluster on Top */}
                <group position={[0, 1.9, 0]}>
                    <mesh position={[0, 0.2, 0]} material={materials.frosting}>
                        <sphereGeometry args={[0.3, 16, 16]} />
                    </mesh>
                    <mesh position={[0, 0.5, 0]}>
                        <sphereGeometry args={[0.2, 16, 16]} />
                        <meshStandardMaterial color="#d32f2f" roughness={0.1} />
                    </mesh>
                </group>

            </group>


            {/* --- Front Entrance --- */}
            {/* Pushed out to z = 3.6 (shopRadius + epsilon) to sit ON the wall, not inside it */}
            <group position={[0, 0, shopRadius + 0.1]}>

                {/* Fake Interior (Dark backing) */}
                {/* Sits just behind the door frame to block view of the cream wall */}
                <mesh position={[0, 1.1, -0.05]} material={materials.interior}>
                    <planeGeometry args={[2.1, 2.2]} />
                </mesh>

                {/* Door Frame Structure */}
                <group position={[0, 1.1, 0]}>
                    {/* Left Post */}
                    <mesh position={[-1.05, 0, 0]} castShadow material={materials.darkDoor}>
                        <boxGeometry args={[0.1, 2.2, 0.3]} />
                    </mesh>
                    {/* Right Post */}
                    <mesh position={[1.05, 0, 0]} castShadow material={materials.darkDoor}>
                        <boxGeometry args={[0.1, 2.2, 0.3]} />
                    </mesh>
                    {/* Top Post */}
                    <mesh position={[0, 1.05, 0]} castShadow material={materials.darkDoor}>
                        <boxGeometry args={[2.2, 0.1, 0.3]} />
                    </mesh>
                </group>

                {/* Door Panels */}
                <group
                    position={[0, 1.1, 0]}
                    onClick={handleDoorClick}
                    onPointerOver={() => document.body.style.cursor = 'pointer'}
                    onPointerOut={() => document.body.style.cursor = 'auto'}
                >
                    {/* Left Door */}
                    <group position={[-0.5, 0, 0]}>
                        {/* Glass */}
                        <mesh material={materials.glass}>
                            <boxGeometry args={[0.9, 2, 0.05]} />
                        </mesh>
                        {/* Frames */}
                        <mesh material={materials.frame} position={[-0.42, 0, 0]}>
                            <boxGeometry args={[0.05, 2, 0.06]} />
                        </mesh>
                        <mesh material={materials.frame} position={[0.42, 0, 0]}>
                            <boxGeometry args={[0.05, 2, 0.06]} />
                        </mesh>
                        <mesh material={materials.frame} position={[0, 0.97, 0]}>
                            <boxGeometry args={[0.9, 0.05, 0.06]} />
                        </mesh>
                        <mesh material={materials.frame} position={[0, -0.97, 0]}>
                            <boxGeometry args={[0.9, 0.05, 0.06]} />
                        </mesh>
                        {/* Handle */}
                        <mesh position={[0.35, 0, 0.06]} material={materials.metal}>
                            <cylinderGeometry args={[0.02, 0.02, 0.4]} />
                        </mesh>
                    </group>

                    {/* Right Door */}
                    <group position={[0.5, 0, 0]}>
                        {/* Glass */}
                        <mesh material={materials.glass}>
                            <boxGeometry args={[0.9, 2, 0.05]} />
                        </mesh>
                        {/* Frames */}
                        <mesh material={materials.frame} position={[-0.42, 0, 0]}>
                            <boxGeometry args={[0.05, 2, 0.06]} />
                        </mesh>
                        <mesh material={materials.frame} position={[0.42, 0, 0]}>
                            <boxGeometry args={[0.05, 2, 0.06]} />
                        </mesh>
                        <mesh material={materials.frame} position={[0, 0.97, 0]}>
                            <boxGeometry args={[0.9, 0.05, 0.06]} />
                        </mesh>
                        <mesh material={materials.frame} position={[0, -0.97, 0]}>
                            <boxGeometry args={[0.9, 0.05, 0.06]} />
                        </mesh>
                        {/* Handle */}
                        <mesh position={[-0.35, 0, 0.06]} material={materials.metal}>
                            <cylinderGeometry args={[0.02, 0.02, 0.4]} />
                        </mesh>
                    </group>
                </group>
            </group>


            {/* --- Windows & Awnings --- */}

            {/* Right Window */}
            <group position={[shopRadius - 0.5, 1.5, 1]} rotation={[0, Math.PI / 3, 0]}>
                <mesh castShadow material={materials.frame}>
                    <boxGeometry args={[1.5, 1.2, 0.2]} />
                </mesh>
                <mesh position={[0, 0, 0.11]} material={materials.glass}>
                    <planeGeometry args={[1.3, 1]} />
                </mesh>
                <Awning position={[0, 0.8, 0.2]} width={1.6} />
            </group>

            {/* Left Window */}
            <group position={[-(shopRadius - 0.5), 1.5, 1]} rotation={[0, -Math.PI / 3, 0]}>
                <mesh castShadow material={materials.frame}>
                    <boxGeometry args={[1.5, 1.2, 0.2]} />
                </mesh>
                <mesh position={[0, 0, 0.11]} material={materials.glass}>
                    <planeGeometry args={[1.3, 1]} />
                </mesh>
                <Awning position={[0, 0.8, 0.2]} width={1.6} />
            </group>

            {/* Back Window (Simpler) */}
            <group position={[0, 1.5, -shopRadius + 0.2]} rotation={[0, Math.PI, 0]}>
                <mesh castShadow material={materials.frame}>
                    <boxGeometry args={[2, 1.2, 0.2]} />
                </mesh>
                <mesh position={[0, 0, 0.11]} material={materials.glass}>
                    <planeGeometry args={[1.8, 1]} />
                </mesh>
            </group>


            {/* --- Menu Board (Left of door) --- */}
            <group
                position={[-1.8, 1.2, 2.8]}
                rotation={[0, 0.2, 0]}
                onClick={onMenuClick}
                onPointerOver={() => document.body.style.cursor = 'pointer'}
                onPointerOut={() => document.body.style.cursor = 'auto'}
            >
                <mesh castShadow material={materials.sign}>
                    <boxGeometry args={[0.8, 1.2, 0.1]} />
                </mesh>
                <mesh position={[0, 0, 0.06]}>
                    <planeGeometry args={[0.7, 1.1]} />
                    <meshStandardMaterial color="#333" />
                </mesh>
                {/* Fake Text Lines */}
                {Array.from({ length: 6 }).map((_, i) => (
                    <mesh key={i} position={[0, 0.4 - (i * 0.15), 0.07]}>
                        <planeGeometry args={[0.5, 0.02]} />
                        <meshBasicMaterial color="white" opacity={0.5} transparent />
                    </mesh>
                ))}
            </group>

            {/* --- Street Details --- */}
            <StreetLamp position={[4.5, 0, 2]} />
            <StreetLamp position={[-4.5, 0, 2]} />

            <PlantPot position={[1.5, 0, 3.2]} />
            <PlantPot position={[-1.2, 0, 3.2]} />

            <ChairAndTable position={[3.5, 0, 0]} rotation={[0, 0.5, 0]} />
            <ChairAndTable position={[-3.5, 0, 0]} rotation={[0, -0.5, 0]} />

            {/* Chalkboard Sign (Small A-Frame) */}
            <group position={[1.2, 0.3, 4]} rotation={[0, -0.3, 0]}>
                <mesh castShadow material={materials.frame} rotation={[0.2, 0, 0]} position={[0, 0, 0.15]}>
                    <boxGeometry args={[0.4, 0.6, 0.05]} />
                </mesh>
                <mesh castShadow material={materials.frame} rotation={[-0.2, 0, 0]} position={[0, 0, -0.15]}>
                    <boxGeometry args={[0.4, 0.6, 0.05]} />
                </mesh>
                <mesh rotation={[0.2, 0, 0]} position={[0, 0.05, 0.18]}>
                    <planeGeometry args={[0.3, 0.45]} />
                    <meshStandardMaterial color="#222" />
                </mesh>
            </group>

        </group >
    );
};
